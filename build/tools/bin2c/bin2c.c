/*
 * This program generates a "C" header file containing the
 * contents of a binary file
 */
#include "stdio.h"
#include "stdlib.h"
#include "string.h"

//**************************************************************************
int usage(char* progname)
{
	return fprintf(stderr,
			"\nUsage: %s [options] <filename>\n"
			"    -p                - pad to 256 bytes.\n"
			"    -n <symname>      - use synname as array name, not filename.\n"
			"    -o <outfile>      - write to outfile, not stdout.\n",
			progname
	);
}

//**************************************************************************
int main(int argc, char** argv)
{
	FILE* in;
	FILE* out;
	char* progname;
	char* poutfile;
	char* pinfile;
	char  xname[1024];
	char* symname;
	char* pn;
	int   argo;
	int   pad;
	
	int   ntot, norg;	
	int   i, ic, nc;
	
	progname = *argv;
	while(progname && (*progname == '.' || *progname == '/' || *progname == '\\'))
	{
		progname++;
	}
	if(argc < 2)
	{
		return usage(progname);
	}
	argv++;
	argc--;

	poutfile = NULL;
	symname  = NULL;
	xname[0] = '\0';	
	pad = 0;
	
	while(argc > 0)
	{
		if((*argv)[0] == '-')
		{
			char opt = (*argv)[1];
			
			if((*argv)[2])
			{
				argo = 2;
			}
			else if(opt != 'p')
			{
				argo = 0;
				argv++;
				argc--;
				if(argc < 0 || ! *argv)
				{
					return usage(progname);
				}
			}
			switch(opt)
			{
			case 'o':		// out file
				poutfile = *argv + argo;
				break;
			case 'p':		// pad
				pad = 1;
				break;
			case 'n':		// use name for sym, not filename
				symname = *argv + argo;
				break;
			default:
				fprintf(stderr, "%s - bad switch %c\n", progname, opt);
				return usage(progname);
			}
			argv++;
			argc--;
		}
		else
		{
			argc--;
			if(argc == 0)
			{
				pinfile = *argv++;
				break;
			}
			else
			{
				fprintf(stderr, "%s - bad parm %s\n", progname, *argv);
				return usage(progname);
			}
		}
	}
	if(! pinfile)
	{
		return usage(progname);
	}
	in = fopen(pinfile, "rb");
	if(! in)
	{
		return fprintf(stderr, "%s: can't open %s\n", progname, pinfile);
	}
	if(poutfile)
	{
		out = fopen(poutfile, "w");
	}
	else
	{
		poutfile = "stdout";
		out = stdout;
	}
	if(! out)
	{
		fclose(in);
		return fprintf(stderr, "%s: can't write %s\n", progname, poutfile);
	}
	pn = pinfile + strlen(pinfile) - 1;
	while(pn >= pinfile)
	{
		if(*pn == '\\' || *pn == '/' || *pn == ':')
			break;
		pn--;
	}
	pn++;
	
	for(i = 0; i < (sizeof(xname) - 1) && *pn; pn++)
	{
		if(*pn == '.')
			break;
	//	if(*pn >= 'a' && *pn <= 'z')
	//		xname[i++] = *pn + ('A' - 'a');
	//	else
			xname[i++] = *pn;
	}
	xname[i] = '\0';
	if(! symname)
		symname = xname;
	
	fprintf(out, "/*\n * Generated File DO NOT EDIT\n *\n * Generated by %s\n */\n",
			progname);
	if(symname == xname)
		fprintf(out, "#ifndef %s_H\n#define %s_H 1\n\n", xname, xname);
	fprintf(out,
			"#ifndef B2C_POST_ALIGN\n"
			"  #if defined(__GNU__) || defined(__GNUC__)\n"
			"    #define B2C_POST_ALIGN(b) __attribute__ ((aligned (b)))\n"
			"  #else\n"
			"    #define B2C_POST_ALIGN(b)\n"
			"  #endif\n"
			"#endif\n"
		);
	fprintf(out,
			"#ifndef B2C_PRE_ALIGN\n"
			"  #if defined(__armcc) || defined(__CC_ARM)\n"
			"    #define B2C_PRE_ALIGN(b) __align(b)\n"
			"  #else\n"
			"    #define B2C_PRE_ALIGN(b)\n"
			"  #endif\n"
			"#endif\n"
		);
	fprintf(out, "const unsigned char B2C_PRE_ALIGN(8) g_%s[] B2C_POST_ALIGN(8) = {\n\t", symname);
	
	i = 0;
	ic = fgetc(in);
	if(ic == EOF)
	{
		// not a single byte, put one in to keep msvc happy
		fprintf(out, "0x00, 0x00, 0x00, 0x00\n");
		ntot = 4;
	}
	else
	{
		ntot = 1;
	}
	while(ic != EOF)
	{
		nc = fgetc(in);
		fprintf(out, "0x%02X", ic);
		if(nc != EOF)
		{
			ntot++;
			fprintf(out, ", ");
		}
		else
		{
			if(! pad || ! (ntot & 0xFF))
				fprintf(out, "\n");
		}
		if(++i == 16) 
		{
			fprintf(out, "\n\t");
			i = 0;
		}
		ic = nc;
	}
	norg = ntot;
	if(pad)
	{
		while(ntot & 0xFF)
		{
			fprintf(out, ",0x00 ");
			if(++i == 16) 
			{
				fprintf(out, "\n\t");
				i = 0;
			}
			ntot++;
		}
	}
	fprintf(out, "};\n\n");
	fprintf(out, "const unsigned long g_%sorigz = %d;\n\n", symname, norg);
	fprintf(out, "const unsigned long g_%sz = %d;\n\n", symname, ntot);
	if(symname == xname)
		fprintf(out, "#endif /* %s_H */\n", xname);
	if(out != stdout)
	{
		fclose(out);
	}
	fclose(in);
	return 0;
}


